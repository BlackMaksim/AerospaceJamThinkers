<!DOCTYPE html>
<html>
<head>
    <title>Aerospace Jam - Mission Control L4</title>
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    
    <style>
        body { font-family: 'Segoe UI', monospace; background: #1a1a1a; color: #ecf0f1; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #2d2d2d; border-radius: 10px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); border: 1px solid #444; }
        h2 { margin-top: 0; color: #4caf50; font-size: 1.1rem; border-bottom: 1px solid #444; padding-bottom: 5px; text-transform: uppercase; }
        .pos-grid { display: flex; justify-content: space-around; font-size: 1.8rem; font-weight: bold; font-family: monospace; padding: 10px 0; }
        .rot-grid { display: flex; justify-content: space-around; font-size: 1.5rem; font-weight: bold; font-family: monospace; padding: 10px 0; border-top: 1px solid #444; margin-top: 10px;}
        .val-box { text-align: center; }
        .label { font-size: 0.8rem; color: #888; display: block; }
        .controls { grid-column: 1 / -1; text-align: center; margin-bottom: 20px; background: #222; padding: 15px; border-radius: 10px; }
        button { padding: 15px 40px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; margin: 0 10px; font-weight: bold; color: white; transition: all 0.2s; }
        .btn-fwd { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }
        .btn-stop { background: #c0392b; box-shadow: 0 4px 0 #922b21; }
        .btn-bwd { background: #f39c12; box-shadow: 0 4px 0 #d35400; }
        button:active { transform: translateY(4px); box-shadow: none; }
        canvas { max-height: 180px; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>üöÄ LEVEL 4: NAVIGATION SYSTEM (VERLET MODE)</h1>
        <button class="btn-fwd" onclick="sendCommand('forward')">‚¨ÜÔ∏è FORWARD</button>
        <button class="btn-stop" onclick="sendCommand('stop')">‚èπÔ∏è STOP</button>
        <button class="btn-bwd" onclick="sendCommand('backward')">‚¨áÔ∏è BACKWARD</button>
    </div>

    <div class="dashboard">
        <div class="card" style="grid-column: 1 / -1; border: 1px solid #f1c40f;">
            <h2 style="color: #f1c40f;">üìç Integrated Navigation Data (Absolute Position)</h2>
            <div class="pos-grid">
                <div class="val-box"><span class="label">POS X (m)</span><span id="posX" style="color: #f1c40f">0.00</span></div>
                <div class="val-box"><span class="label">POS Y (m)</span><span id="posY" style="color: #e67e22">0.00</span></div>
                <div class="val-box"><span class="label">POS Z (m)</span><span id="posZ" style="color: #e74c3c">0.00</span></div>
            </div>
            <canvas id="posChart"></canvas>
        </div>

        <div class="card">
            <h2>üìà Acceleration (m/s¬≤)</h2>
            <canvas id="accelChart"></canvas>
        </div>

        <div class="card">
            <h2>üîÑ Absolute Rotation (deg)</h2>
            <div class="rot-grid">
                <div class="val-box"><span class="label">ROLL</span><span id="rotX" style="color: #3498db">0.0</span></div>
                <div class="val-box"><span class="label">PITCH</span><span id="rotY" style="color: #9b59b6">0.0</span></div>
                <div class="val-box"><span class="label">YAW</span><span id="rotZ" style="color: #1abc9c">0.0</span></div>
            </div>
        </div>

        <div class="card">
            <h2>üì° LiDAR / Barometer</h2>
            <div style="display: flex; justify-content: space-around;">
                <div id="lidarVal" style="font-size: 2rem; color: #00bcd4;">-- cm</div>
                <div id="pressVal" style="font-size: 2rem; color: #00bcd4;">-- hPa</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        const maxDataPoints = 40;

        const commonOptions = {
            responsive: true, maintainAspectRatio: false, animation: false,
            scales: {
                x: { ticks: { display: false }, grid: { color: '#333' } },
                y: { ticks: { color: '#888' }, grid: { color: '#333' } }
            },
            plugins: { legend: { labels: { color: '#fff' } } },
            elements: { point: { radius: 0 }, line: { tension: 0.1 } }
        };

        const ctxPos = document.getElementById('posChart').getContext('2d');
        const posChart = new Chart(ctxPos, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Pos X', borderColor: '#f1c40f', data: [], borderWidth: 2 },
                { label: 'Pos Y', borderColor: '#e67e22', data: [], borderWidth: 2 },
                { label: 'Pos Z', borderColor: '#e74c3c', data: [], borderWidth: 2 }
            ]},
            options: commonOptions
        });

        const ctxAccel = document.getElementById('accelChart').getContext('2d');
        const accelChart = new Chart(ctxAccel, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Acc X', borderColor: '#ff6384', data: [], borderWidth: 2 },
                { label: 'Acc Y', borderColor: '#36a2eb', data: [], borderWidth: 2 },
                { label: 'Acc Z', borderColor: '#cc65fe', data: [], borderWidth: 2 }
            ]},
            options: commonOptions
        });

        socket.on('update_data', (msg) => {
            if(msg.posX !== undefined) {
                document.getElementById('posX').innerText = msg.posX.toFixed(2);
                document.getElementById('posY').innerText = msg.posY.toFixed(2);
                document.getElementById('posZ').innerText = msg.posZ.toFixed(2);
                document.getElementById('rotX').innerText = msg.rotX.toFixed(1);
                document.getElementById('rotY').innerText = msg.rotY.toFixed(1);
                document.getElementById('rotZ').innerText = msg.rotZ.toFixed(1);
                document.getElementById('lidarVal').innerText = msg.lidarDistance + " cm";
                document.getElementById('pressVal').innerText = msg.barometricPressure + " hPa";

                addData(posChart, msg.time, [msg.posX, msg.posY, msg.posZ]);
                addData(accelChart, msg.time, [msg.accelX, msg.accelY, msg.accelZ]);
            }
        });

        function addData(chart, label, newValues) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset, index) => dataset.data.push(newValues[index]));
            if (chart.data.labels.length > maxDataPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(ds => ds.data.shift());
            }
            chart.update();
        }

        function sendCommand(act) { socket.emit('control_motor', { action: act }); }
    </script>
</body>
</html>